/* eslint-disable @typescript-eslint/no-explicit-any */
import { Shield, Plus, Trash } from 'lucide-react';

interface IntegrationsTabProps {
    credentials: any;
    n8nUrl: string; setN8nUrl: (v: string) => void;
    n8nApiKey: string; setN8nApiKey: (v: string) => void;
    googleMapsApiKey: string; setGoogleMapsApiKey: (v: string) => void;
    globalConfig: { id: string; key: string; value: string }[];
    setGlobalConfig: (v: { id: string; key: string; value: string }[]) => void;
    onSave: () => void;
}

export const IntegrationsTab = ({
    credentials, n8nUrl, setN8nUrl, n8nApiKey, setN8nApiKey,
    googleMapsApiKey, setGoogleMapsApiKey,
    globalConfig, setGlobalConfig, onSave
}: IntegrationsTabProps) => (
    <div className="space-y-8">
        <div className="bg-zinc-900 border border-zinc-800 overflow-hidden">
            {/* FIXED: Changed bg-zinc-950/50 to bg-zinc-950 to remove opacity and fix light mode grey issue */}
            <div className="p-4 border-b border-zinc-800 bg-zinc-950 flex items-center justify-between">
                <div className="flex items-center gap-3">
                    <div className={`h-2 w-2 ${credentials?.is_connected ? 'bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)]' : 'bg-red-500'}`} />
                    <span className="text-sm font-bold text-zinc-400">Connection Status</span>
                </div>
                <span className={`text-xs px-2 py-1 bg-zinc-900 border border-zinc-800 ${credentials?.is_connected ? 'text-green-400' : 'text-zinc-500'}`}>
                    {credentials?.is_connected ? 'CONNECTED' : 'DISCONNECTED'}
                </span>
            </div>

            <div className="p-6 space-y-6">

                <div className="text-center py-6 px-4">
                    <Shield className="h-8 w-8 text-zinc-700 mx-auto mb-3" />
                    <h3 className="text-base text-white font-bold mb-1">Google Workspace Setup</h3>
                    <p className="text-xs text-zinc-500 max-w-sm mx-auto mb-4">
                        To use features like Gmail, Drive, and Calendar, connect your account.
                    </p>

                    <div className="text-left text-[10px] bg-black p-3 border border-zinc-800 mb-5 max-w-md mx-auto">
                        <p className="font-bold text-zinc-300 mb-1.5">Quick Setup Guide:</p>
                        <ol className="list-decimal pl-4 space-y-1 text-zinc-500">
                            <li>Go to <a href="https://console.cloud.google.com/" target="_blank" rel="noreferrer" className="text-blue-400 hover:text-blue-300 underline">Google Cloud Console</a> & create a Project.</li>
                            <li>Enable <em>Gmail, Drive, Calendar APIs</em>.</li>
                            <li>Create OAuth Client ID (Desktop App).</li>
                            <li>Download JSON and paste below.</li>
                        </ol>
                    </div>

                    <a
                        href="/auth/login"
                        className="inline-flex items-center justify-center gap-2 bg-white text-black px-6 py-2.5 text-xs font-bold hover:bg-zinc-200 transition-colors uppercase tracking-wide"
                    >
                        <Shield className="h-3.5 w-3.5" />
                        {credentials?.token_uri ? "Reconnect Account" : "Connect Account"}
                    </a>
                </div>

                <div className="border-t border-zinc-800 pt-6 space-y-4">
                    {/* Upload Area */}
                    <details className="group appearance-none">
                        <summary className="cursor-pointer text-xs font-bold text-zinc-400 hover:text-white list-none flex items-center gap-2 p-3 bg-zinc-950 border border-zinc-800 hover:border-zinc-700 transition-colors">
                            <span>+ PASTE CREDENTIALS.JSON CONTENT</span>
                        </summary>
                        <div className="mt-2">
                            <textarea
                                className="w-full h-32 bg-black border border-zinc-800 p-3 text-[10px] font-mono text-zinc-300 focus:border-white focus:outline-none resize-none"
                                placeholder='{"installed":{"client_id":"...","project_id":"..."}}'
                                onChange={async (e) => {
                                    const val = e.target.value;
                                    try {
                                        JSON.parse(val);
                                        const res = await fetch('/api/setup/google-credentials', {
                                            method: 'POST',
                                            body: val,
                                            headers: { 'Content-Type': 'application/json' }
                                        });
                                        if (res.ok) alert("Credentials Saved! Please restart backend to apply.");
                                    } catch (err) {
                                        console.error(err);
                                    }
                                }}
                            />
                        </div>
                    </details>

                    {/* Token Import */}
                    <details className="group appearance-none">
                        <summary className="cursor-pointer text-xs font-bold text-zinc-500 hover:text-white mt-2 list-none flex items-center gap-2">
                            <span className="underline decoration-dotted decoration-zinc-700 hover:decoration-zinc-500">Advanced: Import existing Token JSON (Skip OAuth)</span>
                        </summary>
                        <div className="mt-2">
                            <textarea
                                className="w-full h-24 bg-black border border-zinc-800 p-3 font-mono text-xs text-zinc-300 focus:border-white focus:outline-none resize-none"
                                placeholder='{"token": "...", "refresh_token": "..."}'
                                onChange={async (e) => {
                                    const val = e.target.value;
                                    try {
                                        JSON.parse(val);
                                        const res = await fetch('/api/setup/google-token', {
                                            method: 'POST',
                                            body: val,
                                            headers: { 'Content-Type': 'application/json' }
                                        });
                                        if (res.ok) alert("Token Saved! Restarting backend...");
                                    } catch (err) {
                                        console.error(err);
                                    }
                                }}
                            />
                        </div>
                    </details>
                </div>
            </div>
        </div>

        {/* n8n Integration */}
        <div className="bg-zinc-900 border border-zinc-800 overflow-hidden">
            <div className="p-4 border-b border-zinc-800 bg-zinc-950 flex items-center justify-between">
                <div className="flex items-center gap-3">
                    <div className={`h-2 w-2 ${n8nApiKey ? 'bg-green-500' : 'bg-red-500'}`} />
                    <span className="text-sm font-bold text-zinc-400">n8n</span>
                </div>
                <span className={`text-xs px-2 py-1 bg-zinc-900 border border-zinc-800 ${n8nApiKey ? 'text-green-400' : 'text-zinc-500'}`}>
                    {n8nApiKey ? 'CONFIGURED' : 'NOT CONFIGURED'}
                </span>
            </div>
            <div className="p-6 space-y-6">
                <div className="space-y-2">
                    <label className="text-xs uppercase font-bold text-zinc-500 tracking-wider">n8n URL</label>
                    <input
                        type="text"
                        value={n8nUrl}
                        onChange={(e) => setN8nUrl(e.target.value)}
                        className="w-full bg-zinc-900 border border-zinc-800 p-3 text-sm text-white focus:border-white focus:outline-none transition-colors font-mono"
                        placeholder="http://localhost:5678"
                    />
                    <p className="text-xs text-zinc-600">Defaults to localhost for local dev. Use your production n8n base URL in deployment.</p>
                </div>
                <div className="space-y-2">
                    <label className="text-xs uppercase font-bold text-zinc-500 tracking-wider">n8n API Key</label>
                    <input
                        type="password"
                        value={n8nApiKey}
                        onChange={(e) => setN8nApiKey(e.target.value)}
                        className="w-full bg-zinc-900 border border-zinc-800 p-3 text-sm text-white focus:border-white focus:outline-none transition-colors font-mono"
                        placeholder="X-N8N-API-KEY"
                    />
                    <p className="text-xs text-zinc-600">Used server-side to list workflows and derive webhook URLs.</p>
                </div>

                <div className="space-y-4 pt-4 border-t border-zinc-800">
                    <div className="flex items-center justify-between">
                        <div>
                            <h4 className="text-xs uppercase font-bold text-zinc-500 tracking-wider">Global Configuration Variables</h4>
                            <p className="text-xs text-zinc-600 mt-1">These values are synced to the &apos;global_config&apos; data table in n8n.</p>
                        </div>
                        <button
                            onClick={() => setGlobalConfig([...globalConfig, { id: Math.random().toString(36).substr(2, 9), key: '', value: '' }])}
                            className="flex items-center gap-1.5 px-3 py-1.5 bg-zinc-800 hover:bg-zinc-700 text-white text-[10px] font-bold uppercase transition-colors"
                        >
                            <Plus className="h-3 w-3" /> Add Variable
                        </button>
                    </div>

                    <div className="space-y-2">
                        {globalConfig.length === 0 ? (
                            <div className="text-center py-4 bg-zinc-950 border border-zinc-800 border-dashed text-zinc-600 text-xs italic">
                                No global variables configured.
                            </div>
                        ) : (
                            <div className="space-y-2">
                                {globalConfig.map((item, idx) => (
                                    <div key={item.id} className="flex gap-2 items-start animate-in fade-in slide-in-from-left-2 duration-200">
                                        <input
                                            type="text"
                                            value={item.key}
                                            onChange={(e) => {
                                                const newConfig = [...globalConfig];
                                                newConfig[idx].key = e.target.value;
                                                setGlobalConfig(newConfig);
                                            }}
                                            placeholder="Key (e.g. USER_ID)"
                                            className="flex-1 bg-zinc-950 border border-zinc-800 p-2 text-xs text-white focus:border-white focus:outline-none font-mono placeholder:text-zinc-700"
                                        />
                                        <input
                                            type="text"
                                            value={item.value}
                                            onChange={(e) => {
                                                const newConfig = [...globalConfig];
                                                newConfig[idx].value = e.target.value;
                                                setGlobalConfig(newConfig);
                                            }}
                                            placeholder="Value"
                                            className="flex-[2] bg-zinc-950 border border-zinc-800 p-2 text-xs text-white focus:border-white focus:outline-none font-mono placeholder:text-zinc-700"
                                        />
                                        <button
                                            onClick={() => setGlobalConfig(globalConfig.filter(i => i.id !== item.id))}
                                            className="p-2 text-zinc-600 hover:text-red-500 hover:bg-zinc-900 transition-colors"
                                            title="Remove variable"
                                        >
                                            <Trash className="h-3.5 w-3.5" />
                                        </button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                </div>
                <div className="pt-2 flex justify-end">
                    <button
                        onClick={onSave}
                        className="px-6 py-2.5 text-sm font-bold bg-white text-black hover:bg-zinc-200 transition-all shadow-lg"
                    >
                        Save Changes
                    </button>
                </div>
            </div>
        </div>

        {/* Google Maps Integration */}
        <div className="bg-zinc-900 border border-zinc-800 overflow-hidden">
            <div className="p-4 border-b border-zinc-800 bg-zinc-950 flex items-center justify-between">
                <div className="flex items-center gap-3">
                    <div className={`h-2 w-2 ${googleMapsApiKey ? 'bg-green-500' : 'bg-red-500'}`} />
                    <span className="text-sm font-bold text-zinc-400">Google Maps</span>
                </div>
                <span className={`text-xs px-2 py-1 bg-zinc-900 border border-zinc-800 ${googleMapsApiKey ? 'text-green-400' : 'text-zinc-500'}`}>
                    {googleMapsApiKey ? 'CONFIGURED' : 'NOT CONFIGURED'}
                </span>
            </div>
            <div className="p-6 space-y-6">
                <div className="space-y-2">
                    <label className="text-xs uppercase font-bold text-zinc-500 tracking-wider">Maps API Key</label>
                    <input
                        type="password"
                        value={googleMapsApiKey}
                        onChange={(e) => setGoogleMapsApiKey(e.target.value)}
                        className="w-full bg-zinc-900 border border-zinc-800 p-3 text-sm text-white focus:border-white focus:outline-none transition-colors font-mono"
                        placeholder="AIza..."
                    />
                    <p className="text-xs text-zinc-600">Used server-side for map distance calculations (Distance Matrix API).</p>
                </div>

                <div className="pt-2 flex justify-end">
                    <button
                        onClick={onSave}
                        className="px-6 py-2.5 text-sm font-bold bg-white text-black hover:bg-zinc-200 transition-all shadow-lg"
                    >
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>
);
